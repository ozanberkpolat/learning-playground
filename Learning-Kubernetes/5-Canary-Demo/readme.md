# Canary / Blue-Green Deployment Demo

## **1️⃣ Prerequisites**

- Minikube installed
- Helm installed
- Access to modify `/etc/hosts` (Windows: `C:\Windows\System32\drivers\etc\hosts`)

---

## **2️⃣ Enable Required Minikube Addons**

```bash
minikube addons enable ingress
minikube addons enable metrics-server
```

- **Ingress**: routes external traffic to your services  
- **Metrics-server**: needed for HPA scaling  

---

## **3️⃣ Helm Chart Setup**

Your Helm chart should include:

- Namespace creation
- Deployments:
  - `backend-v1` (with hardcoded version `v1`)
  - `backend-v2` (with hardcoded version `v2`)
- Service for backend
- Ingress
- HPA
- Load generator Pod (continuously sending requests)

---

### **Values.yaml Example**

```yaml
namespace: canary-demo

app:
  name: backend
  containerPort: 8080
  resources:
    requests:
      cpu: 100m
    limits:
      cpu: 200m

v1:
  replicas: 2
  image: your-backend-v1-image

v2:
  replicas: 1
  image: your-backend-v2-image

loadGenerator:
  enabled: true
  name: loadgen
  image: curlimages/curl:latest
  interval: 0.2

hpa:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 50
```

---

## **4️⃣ Deploy the Demo**

1. Install the Helm chart:

```bash
helm install canary ./canary-demo -n canary-demo
```

2. Verify resources:

```bash
kubectl get all -n canary-demo
kubectl get hpa -n canary-demo
```

---

## **5️⃣ Update Hosts File**

Add entry for Ingress:

```
127.0.0.1 mini-prod.local
```

---

## **6️⃣ Test Load Generator**

View load generator logs:

```bash
kubectl logs -f loadgen -n canary-demo
```

- You should see responses:

```
ok - version v1
ok - version v1
ok - version v2
ok - version v1
```

- This shows which version handles each request.

---

## **7️⃣ Test Backend via Ingress**

```bash
curl http://mini-prod.local/
```

- Responses include `"ok - version v1"` or `"ok - version v2"`.  

---

## **8️⃣ Monitor HPA Scaling**

```bash
kubectl get hpa -n canary-demo -w
kubectl top pods -n canary-demo
```

- HPA will scale replicas up/down based on CPU usage generated by the load generator.  

---

## **9️⃣ Optional: Adjust Canary Traffic**

1. Change `v2.replicas` in `values.yaml`:

```yaml
v2:
  replicas: 2
```

2. Upgrade Helm release:

```bash
helm upgrade canary ./canary-demo -n canary-demo
```

- Gradually increases traffic to `v2` pods to simulate **canary rollout**.  

---

## **10️⃣ Cleanup**

```bash
helm uninstall canary -n canary-demo
kubectl delete namespace canary-demo
```

---

This document fully describes the Canary / Blue-Green deployment demo with **namespace, load generator, HPA, and testing steps**.

